name: External Trigger Validation

on:
  repository_dispatch:
    types: [validate_pr]

permissions:
  actions: write
  contents: read

jobs:
  validate:
    runs-on: windows-latest

    steps:
      - name: Print Received Payload
        shell: pwsh
        run: |
          Write-Host "Branch Name: ${{ github.event.client_payload.branch }}"
          Write-Host "Commit ID: ${{ github.event.client_payload.commit_id }}"
          Write-Host "PR Link: ${{ github.event.client_payload.pr_link }}"
          Write-Host "Repo Name: ${{ github.event.client_payload.repo_name }}"

      - name: Trigger Downstream Workflow
        shell: pwsh
        run: |
          $token = "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"

          $headers = @{
              Authorization = "Bearer $token"
              Accept        = "application/vnd.github+json"
          }

          $repo = "${{ github.repository }}"
          $ref  = "${{ github.ref_name }}"

          $body = @{
              ref = $ref
              inputs = @{
                  branch     = "${{ github.event.client_payload.branch }}"
                  commit_id  = "${{ github.event.client_payload.commit_id }}"
                  pr_link    = "${{ github.event.client_payload.pr_link }}"
                  repo_name  = "${{ github.event.client_payload.repo_name }}"
              }
          } | ConvertTo-Json -Depth 5

          Invoke-RestMethod `
            -Uri "https://api.github.com/repos/RAGHAVENDRA-VAM/DownStreamJob-QG/actions/workflows/downstreamJob.yml/dispatches" `
            -Method Post `
            -Headers $headers `
            -Body $body `
            -ContentType "application/json"
